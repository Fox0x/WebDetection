let video,displaySize,canvas,faceMatcher,isDetectionScoreShow=!1,minConfidence=.8,options=new faceapi.SsdMobilenetv1Options({minConfidence:minConfidence,maxResults:10}),labeledDescriptors=[];function loadVideo(){video=document.querySelector("video"),navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(function(e){video.srcObject=e,video.play(),video.addEventListener("playing",()=>{canvas.style.left=video.getBoundingClientRect().x+"px",document.getElementById("spinner").remove(),document.getElementById("content").style.visibility="visible",localStorage.length?matchFaces():getDetections()})}).catch(function(e){console.log("An error occurred: "+e)})}function initVars(){displaySize={width:video.width,height:video.height},canvas=document.getElementById("canvas"),faceapi.matchDimensions(canvas,displaySize)}Promise.all([faceapi.loadSsdMobilenetv1Model("../models"),faceapi.loadFaceLandmarkModel("../models"),faceapi.loadFaceRecognitionModel("../models"),faceapi.loadTinyFaceDetectorModel("../models")]).then(loadVideo).then(initVars);let i=1;function addToImageList(e){let t=e.detection.box;faceapi.extractFaces(video,[new faceapi.Rect(t.x,t.y,t.width,t.height)]).then(t=>{t.forEach(t=>{i<=4?(document.getElementById("outputImage"+i).src=t.toDataURL(),document.getElementById("outputImage"+i).alt="score: "+e.detection.score,document.getElementById("form"+i).style.visibility="visible",i++):i=1})})}async function getLabeledDescriptors(){if(!labeledDescriptors.length){localStorage.length||await getDetections();for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e),a=Float32Array.from(localStorage.getItem(t).split(","),parseFloat);(labeledDescriptors=[]).push(new faceapi.LabeledFaceDescriptors(t,[a]))}}return labeledDescriptors}function setLabeledDescriptor(e){labeledDescriptors.push(new faceapi.LabeledFaceDescriptors("person "+(labeledDescriptors.length+1),[e.descriptor])),labeledDescriptors.forEach(e=>localStorage.setItem(e.label,e.descriptors))}async function getDetections(){await faceapi.detectAllFaces(video,new faceapi.SsdMobilenetv1Options({minConfidence:.9})).withFaceLandmarks().withFaceDescriptors().then(e=>{e.length?(console.log("Detect "+e.length+" faces"),e.forEach(t=>{addToImageList(t),setLabeledDescriptor(t),getLabeledDescriptors().then(faceMatcher=new faceapi.FaceMatcher(e)),matchFaces()})):getDetections()})}async function matchFaces(){await getLabeledDescriptors().then(e=>faceMatcher=new faceapi.FaceMatcher(e)),setInterval(async()=>{await faceapi.detectAllFaces(video,options).withFaceLandmarks().withFaceDescriptors().then(e=>{canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height),e.forEach(e=>{showDetectionScore(e);let t=faceMatcher.findBestMatch(e.descriptor,.5);"unknown"===t.label?(addToImageList(e),setLabeledDescriptor(e),getLabeledDescriptors().then(e=>faceMatcher=new faceapi.FaceMatcher(e))):drawBox(canvas,e,t.label+"  "+(100-100*t.distance).toFixed(1)+"%")})})},100)}function showDetectionScore(e){isDetectionScoreShow&&console.log(e.detection.score)}function drawBox(e,t,a){new faceapi.draw.DrawBox(faceapi.resizeResults(t,displaySize).detection.box,{label:a}).draw(e)}function increaseConfidence(){minConfidence=Math.min(faceapi.utils.round(minConfidence+.1),.9),document.getElementById("confidenceOutput").value=minConfidence,changeModel()}function decreaseConfidence(){minConfidence=Math.max(faceapi.utils.round(minConfidence-.1),.1),document.getElementById("confidenceOutput").value=minConfidence,changeModel()}function changeModel(){let e=document.getElementById("model");options="tinyFaceDetector"===e.value?new faceapi.TinyFaceDetectorOptions({inputSize:160,scoreThreshold:minConfidence}):new faceapi.SsdMobilenetv1Options({minConfidence:minConfidence,maxResults:10}),console.log("Model "+options._name+" with confidence "+options._minConfidence)}